name: Build IPAVIET App

on:
  workflow_dispatch:

jobs:
  build:
    name: Build iOS App
    runs-on: macos-latest
    
    steps:
      - name: Lấy mã nguồn
        uses: actions/checkout@v4

      - name: San phẳng Entitlements và Signing
        run: |
          # Dùng lệnh sed để "cạo" sạch các quyền đặc biệt và chứng chỉ kẹt trong file gốc
          find . -name "*.pbxproj" -exec sed -i '' 's/CODE_SIGN_ENTITLEMENTS = .*/CODE_SIGN_ENTITLEMENTS = "";/g' {} +
          find . -name "*.pbxproj" -exec sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' {} +
          find . -name "*.pbxproj" -exec sed -i '' 's/DEVELOPMENT_TEAM = .*/DEVELOPMENT_TEAM = "";/g' {} +

      - name: Nấu File IPA (Bỏ qua mọi rào cản)
        run: |
          # Tự động tìm tên dự án
          PROJECT_FILE=$(ls | grep \.xcodeproj | head -n 1)
          SCHEME_NAME=$(xcodebuild -list -project "$PROJECT_FILE" | grep -A 1 "Schemes:" | tail -n 1 | awk '{$1=$1};1')
          
          # Ép Xcode build cho iPhone thực tế mà không cần ký
          xcodebuild clean build \
            -project "$PROJECT_FILE" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ENTITLEMENTS_REQUIRED=NO \
            SYMROOT=$PWD/build

      - name: Đóng gói thành file .ipa
        run: |
          mkdir -p Payload
          # Tìm file .app vừa nấu xong và nhét vào Payload
          mv build/Release-iphoneos/*.app Payload/
          zip -r IPAVIET_Store.ipa Payload

      - name: Giao hàng cho Sếp
        uses: actions/upload-artifact@v4
        with:
          name: IPAVIET_App_Final
          path: IPAVIET_Store.ipa
