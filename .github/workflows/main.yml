name: Build IPAVIET App

on:
  workflow_dispatch:

jobs:
  build:
    name: Build iOS App
    runs-on: macos-latest
    
    steps:
      - name: Lấy mã nguồn
        uses: actions/checkout@v4

      - name: Giải phẫu bằng Ruby (Nâng cấp iOS & Tắt Chứng chỉ)
        run: |
          ruby -e "
          require 'xcodeproj'
          project = Xcodeproj::Project.open('PWAShell.xcodeproj')
          project.targets.each do |target|
            target.build_configurations.each do |config|
              config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
              config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
              config.build_settings['CODE_SIGN_IDENTITY'] = ''
              config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '14.0'
            end
          end
          project.save
          "

      - name: Nấu File IPA (Siêu mượt)
        run: |
          xcodebuild clean build \
            -project PWAShell.xcodeproj \
            -scheme PWAShell \
            -configuration Release \
            -sdk iphoneos \
            -arch arm64 \
            SYMROOT=$PWD/build

      - name: Đóng gói thành .ipa
        run: |
          mkdir -p Payload
          mv build/Release-iphoneos/*.app Payload/
          zip -r IPAVIET_Store.ipa Payload

      - name: Giao hàng cho Sếp
        uses: actions/upload-artifact@v4
        with:
          name: IPAVIET_App_Final
          path: IPAVIET_Store.ipa
