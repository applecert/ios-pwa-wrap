name: Build IPAVIET App

on:
  workflow_dispatch:

jobs:
  build:
    name: Build iOS App
    runs-on: macos-latest
    
    steps:
      - name: Lấy mã nguồn
        uses: actions/checkout@v4

      - name: Cài đặt Tool & Quét tên file tự động
        run: |
          sudo gem install xcodeproj
          PROJECT_FILE=$(ls | grep \.xcodeproj | head -n 1)
          echo "PROJECT_FILE=$PROJECT_FILE" >> $GITHUB_ENV
          SCHEME_NAME=$(xcodebuild -list -project "$PROJECT_FILE" | grep -A 1 "Schemes:" | tail -n 1 | awk '{$1=$1};1')
          echo "SCHEME_NAME=$SCHEME_NAME" >> $GITHUB_ENV

      - name: Giải phẫu bằng Ruby (Chống lỗi vỡ file)
        run: |
          ruby -e "
          require 'xcodeproj'
          project = Xcodeproj::Project.open(ENV['PROJECT_FILE'])
          project.targets.each do |target|
            target.build_configurations.each do |config|
              config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
              config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
              config.build_settings['CODE_SIGN_IDENTITY'] = ''
              config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '14.0'
            end
          end
          project.save
          "

      - name: Nấu File IPA (Siêu mượt)
        run: |
          xcodebuild clean build \
            -project "${{ env.PROJECT_FILE }}" \
            -scheme "${{ env.SCHEME_NAME }}" \
            -configuration Release \
            -sdk iphoneos \
            -arch arm64 \
            SYMROOT=$PWD/build

      - name: Đóng gói thành .ipa
        run: |
          mkdir -p Payload
          mv build/Release-iphoneos/*.app Payload/
          zip -r IPAVIET_Store.ipa Payload

      - name: Giao hàng cho Sếp
        uses: actions/upload-artifact@v4
        with:
          name: IPAVIET_App_Final
          path: IPAVIET_Store.ipa
