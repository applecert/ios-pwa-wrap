name: Build IPAVIET App

on:
  workflow_dispatch:

jobs:
  build:
    name: Build iOS App
    runs-on: macos-latest
    
    steps:
      - name: L·∫•y m√£ ngu·ªìn
        uses: actions/checkout@v4

      - name: L√πng s·ª•c v√† ƒê√≥ng g√≥i (Auto-Detect)
        run: |
          # 1. T·ª± ƒë·ªông t√¨m t√™n Project v√† Scheme (Ch·ªëng l·ªói sai t√™n Exit code 66)
          PROJECT_FILE=$(ls | grep \.xcodeproj | head -n 1)
          SCHEME_NAME=$(xcodebuild -list -project "$PROJECT_FILE" | grep -A 1 "Schemes:" | tail -n 1 | awk '{$1=$1};1')
          
          echo "üéØ ƒê√£ t√¨m th·∫•y Project: $PROJECT_FILE"
          echo "üéØ ƒê√£ t√¨m th·∫•y Scheme: $SCHEME_NAME"
          
          # 2. √âp m√°y ch·ªß Apple Build kh√¥ng c·∫ßn ch·ª©ng ch·ªâ
          xcodebuild clean build \
            -project "$PROJECT_FILE" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED="NO" \
            CODE_SIGNING_ALLOWED="NO" \
            CODE_SIGN_ENTITLEMENTS="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            SYMROOT=$PWD/build
            
          # 3. N√©n th√†nh file .ipa
          mkdir -p Payload
          mv build/Release-iphoneos/*.app Payload/
          zip -r IPAVIET_Store.ipa Payload

      - name: Nh·∫£ file IPA cho S·∫øp
        uses: actions/upload-artifact@v4
        with:
          name: IPAVIET_App_V1
          path: IPAVIET_Store.ipa
